<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Reinhold Bader (1966–2024)" />
  <meta name="dcterms.date" content="2024-01-01" />
  <meta name="keywords" content="Fortran, OOP" />
  <title>Putting Fortran’s object-related features to practical use</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="./html_style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Putting Fortran’s object-related features to practical
use</h1>
<p class="author">Reinhold Bader (1966–2024)</p>
<p class="date">2024</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#sec:oop_techniques" id="toc-sec:oop_techniques"><span
class="toc-section-number">1</span> Object-based programming
techniques</a></li>
<li><a href="#introduction-container-like-types"
id="toc-introduction-container-like-types"><span
class="toc-section-number">2</span> Introduction: Container-like
types</a></li>
<li><a href="#examples-for-definitions-of-container-like-types"
id="toc-examples-for-definitions-of-container-like-types"><span
class="toc-section-number">3</span> Examples for definitions of
container-like types</a>
<ul>
<li><a href="#allocatable-components"
id="toc-allocatable-components"><span
class="toc-section-number">3.1</span> Allocatable components</a></li>
<li><a href="#pointer-components" id="toc-pointer-components"><span
class="toc-section-number">3.2</span> Pointer components</a></li>
</ul></li>
<li><a href="#constructing-objects-of-container-like-type"
id="toc-constructing-objects-of-container-like-type"><span
class="toc-section-number">4</span> Constructing objects of
container-like type</a></li>
<li><a href="#copying-objects-of-container-like-type"
id="toc-copying-objects-of-container-like-type"><span
class="toc-section-number">5</span> Copying objects of container-like
type</a></li>
<li><a href="#finalization-and-conclusions"
id="toc-finalization-and-conclusions"><span
class="toc-section-number">6</span> Finalization and
conclusions</a></li>
<li><a
href="#further-language-features-useful-for-object-based-programming"
id="toc-further-language-features-useful-for-object-based-programming"><span
class="toc-section-number">7</span> Further language features useful for
object-based programming</a>
<ul>
<li><a href="#extended-semantics-for-allocatable-objects"
id="toc-extended-semantics-for-allocatable-objects"><span
class="toc-section-number">7.1</span> Extended semantics for allocatable
objects</a></li>
<li><a href="#implementing-move-semantics"
id="toc-implementing-move-semantics"><span
class="toc-section-number">7.2</span> Implementing move
semantics</a></li>
<li><a href="#the-block-construct" id="toc-the-block-construct"><span
class="toc-section-number">7.3</span> The <code>BLOCK</code>
construct</a></li>
<li><a href="#the-associate-construct"
id="toc-the-associate-construct"><span
class="toc-section-number">7.4</span> The <code>ASSOCIATE</code>
construct</a></li>
</ul></li>
<li><a href="#performing-io-with-objects-of-container-like-type"
id="toc-performing-io-with-objects-of-container-like-type"><span
class="toc-section-number">8</span> Performing I/O with objects of
container-like type</a></li>
<li><a href="#object-oriented-programming-techniques"
id="toc-object-oriented-programming-techniques"><span
class="toc-section-number">9</span> Object-oriented programming
techniques</a></li>
<li><a
href="#introduction-establishing-an-explicit-relationship-between-types"
id="toc-introduction-establishing-an-explicit-relationship-between-types"><span
class="toc-section-number">10</span> Introduction: Establishing an
explicit relationship between types</a></li>
<li><a href="#extension-types" id="toc-extension-types"><span
class="toc-section-number">11</span> Extension types</a></li>
<li><a href="#polymorphism" id="toc-polymorphism"><span
class="toc-section-number">12</span> Polymorphism</a>
<ul>
<li><a href="#declaring-entities-with-class"
id="toc-declaring-entities-with-class"><span
class="toc-section-number">12.1</span> Declaring entities with
<code>CLASS</code></a></li>
<li><a href="#run-time-type-and-class-identification"
id="toc-run-time-type-and-class-identification"><span
class="toc-section-number">12.2</span> Run-time type and class
identification</a></li>
<li><a href="#unlimited-polymorphic-objects"
id="toc-unlimited-polymorphic-objects"><span
class="toc-section-number">12.3</span> Unlimited polymorphic
objects</a></li>
</ul></li>
<li><a href="#sec:tbp" id="toc-sec:tbp"><span
class="toc-section-number">13</span> Type-bound procedures
(TBP)</a></li>
<li><a href="#abstract-types-and-interfaces"
id="toc-abstract-types-and-interfaces"><span
class="toc-section-number">14</span> Abstract types and
interfaces</a></li>
<li><a href="#generic-type-bound-procedures-and-operator-overloading"
id="toc-generic-type-bound-procedures-and-operator-overloading"><span
class="toc-section-number">15</span> Generic type-bound procedures and
operator overloading</a></li>
<li><a href="#completing-the-dependency-inversion"
id="toc-completing-the-dependency-inversion"><span
class="toc-section-number">16</span> Completing the dependency
inversion</a>
<ul>
<li><a href="#discussion-of-structural-dependencies"
id="toc-discussion-of-structural-dependencies"><span
class="toc-section-number">16.1</span> Discussion of structural
dependencies</a></li>
<li><a href="#using-submodules-to-break-dependency-cycles"
id="toc-using-submodules-to-break-dependency-cycles"><span
class="toc-section-number">16.2</span> Using submodules to break
dependency cycles</a></li>
<li><a href="#implementation-of-the-constructor"
id="toc-implementation-of-the-constructor"><span
class="toc-section-number">16.3</span> Implementation of the
constructor</a></li>
<li><a href="#diagramming-the-dependencies-between-program-units"
id="toc-diagramming-the-dependencies-between-program-units"><span
class="toc-section-number">16.4</span> Diagramming the dependencies
between program units</a></li>
</ul></li>
<li><a href="#performance-and-ease-of-use"
id="toc-performance-and-ease-of-use"><span
class="toc-section-number">17</span> Performance and ease of
use</a></li>
<li><a href="#sec:functions_with_parameters"
id="toc-sec:functions_with_parameters"><span
class="toc-section-number">18</span> Functions with parameters</a>
<ul>
<li><a href="#a-type-definition-for-invocation-of-a-general-function"
id="toc-a-type-definition-for-invocation-of-a-general-function"><span
class="toc-section-number">18.1</span> A type definition for invocation
of a general function</a></li>
<li><a
href="#performance-issues-arising-from-object-oriented-programming"
id="toc-performance-issues-arising-from-object-oriented-programming"><span
class="toc-section-number">18.2</span> Performance issues arising from
object-oriented programming</a></li>
<li><a href="#completing-the-function-type-definition"
id="toc-completing-the-function-type-definition"><span
class="toc-section-number">18.3</span> Completing the function type
definition</a></li>
<li><a href="#using-the-function-type"
id="toc-using-the-function-type"><span
class="toc-section-number">18.4</span> Using the function type</a></li>
</ul></li>
<li><a href="#arrays-of-structures-versus-structures-of-arrays"
id="toc-arrays-of-structures-versus-structures-of-arrays"><span
class="toc-section-number">19</span> Arrays of structures versus
structures of arrays</a></li>
<li><a href="#comments-on-further-language-features"
id="toc-comments-on-further-language-features"><span
class="toc-section-number">20</span> Comments on further language
features</a>
<ul>
<li><a href="#variations-on-the-passed-object"
id="toc-variations-on-the-passed-object"><span
class="toc-section-number">20.1</span> Variations on the passed
object</a></li>
</ul></li>
</ul>
</nav>
<p>This article describes how advanced Fortran language features can be
applied toward object-based and object-oriented programming techniques.
These are, of course, to a significant extent a matter of taste,
personal style and possibly overarching program design considerations,
so should be taken with a pinch of salt.</p>
<p>Language features from Fortran 95 and later will be used; those from
Fortran 2003 and later will also be shortly described. They are
explained in more detail in e.g., Metcalf, Reid, Cohen and Bader.<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a> See also <a
href="https://en.wikipedia.org/wiki/Fortran_95_language_features">Fortran
95 language features</a> for the language’s fundamentals; the
prerequisite for understanding this article is that features explained
there are well understood.</p>
<p>Boldface will be used where term definitions are introduced. They are
additionally annotated by “(not a Fortran term)” or similar if the term
is not used in the Fortran standard itself, but is in general use in the
technical literature.</p>
<p>Compilable and runnable example code is available from an external <a
href="https://github.com/reinh-bader/object_fortran">Github
repository</a>.</p>
<h1 data-number="1" id="sec:oop_techniques"><span
class="header-section-number">1</span> Object-based programming
techniques</h1>
<h1 data-number="2" id="introduction-container-like-types"><span
class="header-section-number">2</span> Introduction: Container-like
types</h1>
<p>The word “Container-like” is not a Fortran term, but used in the
context of this article to designate types with components whose size
(or type, to be discussed later) is not known when the type is declared.
For deferred sizing of array objects, this can be achieved by using
either the <code>POINTER</code> or the <code>ALLOCATABLE</code>
attribute for the component’s specification.</p>
<p>The language features and programming techniques will be shown using
two examples introduced in the following section. The demonstration
codes for this chapter can be found in the <code>object_based</code>
folder of the <a
href="https://github.com/reinh-bader/object_fortran">Github
repository</a>.</p>
<h1 data-number="3"
id="examples-for-definitions-of-container-like-types"><span
class="header-section-number">3</span> Examples for definitions of
container-like types</h1>
<h2 data-number="3.1" id="allocatable-components"><span
class="header-section-number">3.1</span> Allocatable components</h2>
<p>As an example for the type definition of a <strong>value
container</strong> (not a Fortran term) with an <code>ALLOCATABLE</code>
component consider</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> polynomial</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> a(:)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>An object declared to be of this type</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(polynomial)</span> <span class="dt">::</span> p</span></code></pre></div>
<p>is suitable for characterization of a polynomial</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mtext mathvariant="normal">degree</mtext></msubsup><msub><mi>a</mi><mi>k</mi></msub><mo>⋅</mo><msup><mi>x</mi><mi>k</mi></msup><mspace width="1.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>∈</mo><mi>ℜ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(x) = \sum_{k=0}^{\text{degree}} a_{k} \cdot x^k \quad (x \in \Re)</annotation></semantics></math></p>
<p>once it has been created and subsequently supplied with values of the
coefficients:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>degree <span class="kw">=</span> ... <span class="co">! integer value known at run time only</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( p<span class="op">%</span>a(<span class="dv">0</span>:degree) )</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>p<span class="op">%</span>a(<span class="dv">0</span>:) <span class="kw">=</span> ...</span></code></pre></div>
<h2 data-number="3.2" id="pointer-components"><span
class="header-section-number">3.2</span> Pointer components</h2>
<p>As an example for the type definition of a <strong>reference
container</strong> (not a Fortran term) with a <code>POINTER</code>
component consider</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> sorted_list</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sortable)</span> <span class="dt">::</span> data</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">POINTER</span> <span class="dt">::</span> next <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>Note that referencing the type itself when declaring a component is
permitted if that component has the <code>POINTER</code> or
<code>ALLOCATABLE</code> attribute; such types are generally known as
<strong>recursive</strong>. They are used to represent information
structures (lists, trees, …), often with specific relationships between
the individual data entries stored in each node. In this example, the
assumption is that entries of type <code>data</code> in subsequent list
items fulfill an ordering condition, based on the functionality supplied
with that type:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">PUBLIC</span> <span class="dt">::</span> sortable</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=:)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> string</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> <span class="kw">OPERATOR</span>(<span class="op">&lt;</span>)          <span class="co">! compare two objects of type sortable</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> less_than  <span class="co">! implementation not shown here</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p><em>Hint:</em> Given that Fortran supports arrays, use of simple
linked lists is in most cases inappropriate. The example is presented
here as being the simplest that permits illustrating the language
features of interest.</p>
<p>An object declared to be</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> my_list</span></code></pre></div>
<p>is suitable as starting point for building a linked list with node
entries of type <code>data</code>. In the simplest case, inserting a
data item into the object is done by executing the following
statements:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sortable)</span> <span class="dt">::</span> my_data</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>my_data <span class="kw">=</span> ...</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>my_list<span class="op">%</span>data <span class="kw">=</span> my_data  <span class="co">! only compiles if type definition is accessible in host</span></span></code></pre></div>
<p>However, as we shall see below, setting up a complete and valid
<code>sorted_list</code> object in a reliable manner needs additional
work.</p>
<h1 data-number="4"
id="constructing-objects-of-container-like-type"><span
class="header-section-number">4</span> Constructing objects of
container-like type</h1>
<p>The semantics of the default structure constructor for container-like
objects needs to account for any additional <code>POINTER</code> or
<code>ALLOCATABLE</code> attribute specified for type components.</p>
<p>For the first example type from the last section, the executable
statements in</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(polynomial)</span> <span class="dt">::</span> q, r</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>q <span class="kw">=</span> polynomial( <span class="kw">[</span><span class="fl">2.</span>, <span class="fl">3.</span>, <span class="fl">1.</span><span class="kw">]</span> )</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>r <span class="kw">=</span> polynomial( null() )</span></code></pre></div>
<p>result in an object <code>q</code> auto-allocated to the value
<code>q%a(1:3) == [2., 3., 1.]</code>, and an object <code>r</code> with
<code>r%a</code> unallocated.</p>
<p>For the second example type from the last section, the executable
statements in</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> sl1</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span>, <span class="dt">target</span> <span class="dt">::</span> sl2</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sortable)</span> <span class="dt">::</span> d1, d2</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>sl1 <span class="kw">=</span> sorted_list( data<span class="kw">=</span>d1, next<span class="kw">=</span>sl2 )  <span class="co">! use keyword notation</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>sl2 <span class="kw">=</span> sorted_list( d2, null() )</span></code></pre></div>
<p>result in an object <code>sl1</code> with <code>sl1%next</code>
pointer associated with <code>sl2</code>, and an object <code>sl2</code>
with <code>sl2%next</code> disassociated; the <code>data</code>
components of both objects have values, <code>d1</code> and
<code>d2</code>, respectively. Note that an argument that matches with a
<code>POINTER</code> component must have either the <code>POINTER</code>
or the <code>TARGET</code> attribute. Also, <strong>keyword
notation</strong> can be used in structure constructors in the same
manner as for procedure arguments.</p>
<p>The default constructor’s behaviour has some properties that one
needs to be aware of:</p>
<ol type="1">
<li>If all type components have the <code>PRIVATE</code> attribute i.e.,
the type is <strong>opaque</strong> (not a Fortran term), it can only be
used if the type declaration is accessed by host association (this is
the same as for nonallocatable/nonpointer components);</li>
<li>especially for container-like types, its semantics may be
incompatible with the programmers intentions for how the objects should
be used.</li>
</ol>
<p>Item 2 is illustrated by the above object setups, specifically:</p>
<ul>
<li>In the <code>polynomial</code> example given above, the lower bound
of <code>q%a</code> is set to 1, contrary to the expectation that it
should be 0. One could account for this by calculating index offsets in
any module procedures that process <code>polynomial</code> objects, but
this makes the code harder to understand and maintain. Also, the degree
of the polynomial should be determined by the last nonzero entry of the
coefficient array, but the language can of course not be aware of
this.</li>
<li>In the <code>sorted_list</code> example given above, the ordering
requirement for entries in subsequent nodes is not checked, so will
usually be not fulfilled. Also, if <code>sl2</code> goes out of scope
before <code>sl1</code> does, the list structure is torn to bits.</li>
</ul>
<p>The programmer can enforce appropriate semantics by overloading the
structure constructor. In this case, it is usually a good idea to
declare the types as being opaque.</p>
<p>Overloading the structure constructor is done by</p>
<ul>
<li>creating a named interface (i.e., a generic function) with the same
name as the type of interest;</li>
<li>creating at least one specific function (a subroutine is not
permitted), usually returning a scalar result of the type of
interest.</li>
</ul>
<p>For the <code>polynomial</code> type the interface block (placed in
the specification section of the module containing the type definition)
might read</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> polynomial</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">! overload to assure correct lower bound when creating a polynomial object</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> <span class="dt">::</span> create_polynomial</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>   ... <span class="co">! further specifics as needed</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>and the implementation of <code>create_polynomial</code> (in the
<code>CONTAINS</code> part of the module) might read</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="dt">TYPE(polynomial)</span> <span class="kw">FUNCTION</span> create_polynomial(a)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> a(<span class="dv">0</span>:)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span> <span class="dt">::</span> degree(<span class="dv">1</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>   degree <span class="kw">=</span> <span class="fu">findloc</span>( a <span class="op">/=</span> <span class="fl">0.0</span>, <span class="dt">value</span><span class="kw">=</span><span class="cn">.true.</span>, back<span class="kw">=</span><span class="cn">.true.</span> ) <span class="kw">-</span> <span class="dv">1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ALLOCATE</span>( create_polynomial<span class="op">%</span>a(<span class="dv">0</span>:degree(<span class="dv">1</span>)) )</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   create_polynomial<span class="op">%</span>a(<span class="dv">0</span>:) <span class="kw">=</span> a(<span class="dv">0</span>:degree(<span class="dv">1</span>))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span></span></code></pre></div>
<p>Because its signature matches the default structure constructor’s,
the function actually overrides the default constructor, making it
generally unavailable.</p>
<p>For the <code>sorted_list</code> type the interface block might
read</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> sorted_list</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">! the default constructor is unavailable because the type is opaque</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">! the specific has a different signature than the structure constructor</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> <span class="dt">::</span> create_sorted_list</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>   ... <span class="co">! further specifics as needed</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>with the implementation of <code>create_sorted_list</code> as
follows:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="kw">FUNCTION</span> create_sorted_list(item_array) <span class="kw">RESULT</span>(head)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sortable)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> item_array(:)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> head</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span> <span class="dt">::</span> i</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">DO</span> i <span class="kw">=</span> <span class="dv">1</span>, <span class="fu">size</span>(item_array)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> add_to_sorted_list(head, item_array(i))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">! handles tedious details of pointer fiddling</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END DO</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span></span></code></pre></div>
<p>The constructor has a signature that differs from that of the default
one, but the latter is unavailable outside the host scope of the type
definition anyway, due to the opacity of <code>sorted_list</code>.</p>
<h1 data-number="5" id="copying-objects-of-container-like-type"><span
class="header-section-number">5</span> Copying objects of container-like
type</h1>
<p>Default assignment extends to container-like objects. For objects
declared as</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(polynomial)</span> <span class="dt">::</span> p, q</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> slp, slq</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>... <span class="co">! code that defines p, slp</span></span></code></pre></div>
<p>and after defining values for prospective right-hand sides, execution
of the statement</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>q <span class="kw">=</span> p</span></code></pre></div>
<p>produces the same result as</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">IF</span> ( <span class="fu">allocated</span>(q<span class="op">%</span>a) ) <span class="kw">DEALLOCATE</span>( q<span class="op">%</span>a )</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>q<span class="op">%</span>a <span class="kw">=</span> p<span class="op">%</span>a  <span class="co">! performs auto-allocation using the RHS&#39;s bounds, then copies the value</span></span></code></pre></div>
<p>and execution of the statement</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>slq <span class="kw">=</span> slp</span></code></pre></div>
<p>produces the same result as</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>slq<span class="op">%</span>data <span class="kw">=</span> slp<span class="op">%</span>data</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>slq<span class="op">%</span>next <span class="kw">=</span><span class="op">&gt;</span> slp<span class="op">%</span>next  <span class="co">! creates a reference between list objects without copying any value</span></span></code></pre></div>
<p>The terms <strong>deep copy</strong> and <strong>shallow
copy</strong> (neither are Fortran terms) are sometimes used to describe
the above behaviour for <code>ALLOCATABLE</code> and
<code>POINTER</code> components, respectively. Note that - different
from the default structure constructor - having <code>PRIVATE</code>
components does not affect the use of default assigment. However, the
semantics of default assignment might not be what is needed from the
programmer’s point of view.</p>
<p>Specifically, consider the case where the object <code>slq</code>
above has previously been set up by invoking the overloaded constructor.
The assignment above would then have the following effects:</p>
<ol type="1">
<li>The list elements of the original <code>slq</code>, beginning with
<code>slq%next</code>, would become inaccessible (“orphaned”),
effectively causing a memory leak;</li>
<li>after the assignment statement, <code>slq%next</code> references
into <code>slp%next</code>, resulting in aliasing.</li>
</ol>
<p>To avoid 2., it is possible to <a
href="https://en.wikipedia.org/wiki/Fortran_95_language_features#Derived-data_types"><strong>overload</strong>
the assignment operator</a> for reference containers to create a deep
copy. Note that in the case where defined unary or binary operations are
introduced, the functions that define these need to create deep copies
to create the result variable anyway, otherwise things simply don’t
work. The downside of this is that in code like</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>slq <span class="kw">=</span> slp <span class="kw">//</span> slq</span></code></pre></div>
<p> – with the overloaded concatenation operator meaning that the
argument lists are joined – multiple deep copies need to be done (the
implementation of the module procedure <code>join_lists</code> that
supplies the necessary specific for <code>//</code> is not shown here;
see the source <code>code sorted_list.f90</code> for details). It turns
out that some of these exist only intermediately.</p>
<p>Here an implementation of the specific procedure for the overloaded
assignment of <code>sorted_list</code> objects:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> assign_sorted_list(<span class="kw">to</span>, from)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">TARGET</span> <span class="dt">::</span> from</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">INTENT(out)</span>, <span class="dt">TARGET</span> <span class="dt">::</span> <span class="kw">to</span>  <span class="co">! finalizer is executed on entry,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                                 <span class="co">! see below for discussion of this.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">POINTER</span> <span class="dt">::</span> p, q</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>   p <span class="kw">=</span><span class="op">&gt;</span> from; q <span class="kw">=</span><span class="op">&gt;</span> <span class="kw">to</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>   deep_copy : <span class="kw">DO</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">IF</span> ( <span class="fu">associated</span>(p) ) <span class="kw">THEN</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>         q<span class="op">%</span>data <span class="kw">=</span> p<span class="op">%</span>data</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ELSE</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>         <span class="kw">EXIT</span> deep_copy</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END IF</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      p <span class="kw">=</span><span class="op">&gt;</span> p<span class="op">%</span>next</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">IF</span> ( <span class="fu">associated</span>(p) ) <span class="kw">ALLOCATE</span>( q<span class="op">%</span>next )</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      q <span class="kw">=</span><span class="op">&gt;</span> q<span class="op">%</span>next</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END DO</span> deep_copy</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>Avoiding 1. is usually done by means of finalizers, to be discussed
in the next section. This is because assignment is not the only possible
cause for orphaning of <code>POINTER</code>-related memory (or indeed
other resource leaks).</p>
<h1 data-number="6" id="finalization-and-conclusions"><span
class="header-section-number">6</span> Finalization and conclusions</h1>
<p>To deal with resource leaks that are otherwise not within the
programmer’s means to avoid, a type definition can be connected with a
user-defined <strong>final procedure</strong> that is automatically
invoked in certain situations. For the <code>sorted_list</code> type,
this would look like</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> sorted_list</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sortable)</span> <span class="dt">::</span> data</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">POINTER</span> <span class="dt">::</span> next <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>   <span class="dt">FINAL</span> <span class="dt">::</span> delete_sorted_list</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>Note that the <code>FINAL</code> statement appears after a
<code>CONTAINS</code> statement in the type definition; this implies
that <code>delete_sorted_list</code> is not a regular type component.
The module procedure’s implementation might then be as follows:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="kw">RECURSIVE</span> <span class="kw">SUBROUTINE</span> delete_sorted_list(list)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> list</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">associated</span>(list<span class="op">%</span>next) ) <span class="kw">THEN</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">DEALLOCATE</span>( list<span class="op">%</span>next )  <span class="co">! invokes the finalizer recursively</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>It must be a subroutine that takes a single argument of the type to
be finalized. Most additional attributes are not permitted for that
dummy argument; for the case of finalizing array arguments it is
possible to have a set of finalizers (all listed in the type
definition), each of which declares the dummy argument with an
appropriate rank.</p>
<p><em>Hint:</em> The <code>PURE</code> and <code>RECURSIVE</code>
properties specified above reflect the specific needs for the
<code>sorted_list</code> type and its associated procedures. The
<code>RECURSIVE</code> specification is optional (i.e., procedures can
be called recursively by default), but a <code>NON_RECURSIVE</code>
specification can be supplied if the implementation’s semantics does not
permit correct behaviour in recursive calls.</p>
<p>The finalizer will be automatically invoked on an object if</p>
<ol type="1">
<li>it appears on the left-hand side of an intrinsic assignment
statement (before the assignment is performed),</li>
<li>on invocation of a procedure call where it is argument associated
with an <code>INTENT(out)</code> dummy,</li>
<li>it is a non-saved variable and program execution ends its scope,
or</li>
<li>it is deallocated.</li>
</ol>
<p>Nonpointer nonallocatable function results fall into the third
category above; however, finalization does not apply for the default
structure constructor.</p>
<p>Note that if a finalizer is defined and the constructor is
overloaded, but the assignment operator is <em>not</em>, then the
assignment statement <code>slq = sorted_list(...)</code> (which then
translates into a single function call to the
<code>create_sorted_list()</code> function shown earlier) will result in
a mutilated left-hand side, because the finalizer will be executed on
the function that overloads the constructor, resulting in
<code>slq%next</code> being disassociated. For this reason, the
following guideline applies:</p>
<blockquote>
<p>Recommendation:<br />
Finalizers, overloads for the default constructor, and overload of the
assignment operation should usually be jointly implemented.</p>
</blockquote>
<p>See also the article “<a
href="https://en.wikipedia.org/wiki/Rule_of_three_(C%2B%2B_programming)">Rule
of three</a>” for the analogous situation in C++.</p>
<h1 data-number="7"
id="further-language-features-useful-for-object-based-programming"><span
class="header-section-number">7</span> Further language features useful
for object-based programming</h1>
<h2 data-number="7.1"
id="extended-semantics-for-allocatable-objects"><span
class="header-section-number">7.1</span> Extended semantics for
allocatable objects</h2>
<p>Scalars can have the <code>ALLOCATABLE</code> attribute:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CHARACTER(len=:)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> my_string</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> my_list</span></code></pre></div>
<p>Allocation then can be done explicitly; the following examples
illustrate applications of the <code>ALLOCATE</code> statement that are
useful or even necessary in this context:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( <span class="dt">CHARACTER(len=13)</span> <span class="dt">::</span> my_string )                  <span class="co">! typed allocation</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( my_list, source<span class="kw">=</span>sorted_list(array_of_sortable) )  <span class="co">! sourced allocation</span></span></code></pre></div>
<p><strong>Typed allocation</strong> is necessary for the string
variable, because the length parameter of a string is part of its type;
we will later see that derived types can also appear in the type
specification. <strong>Sourced allocation</strong> permits the creation
of an allocated object that is a clone of the specified source object or
expression.</p>
<p>Alternatively, allocatable objects (be they scalar or arrays) can be
auto-allocated by appearing on the left-hand side of an
<em>intrinsic</em> assignment statement:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>my_string <span class="kw">=</span> <span class="st">&quot;anything goes&quot;</span>  <span class="co">! auto-allocated to RHS length before value is transferred</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">! my_list = sorted_list(array_of_sortable)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">! the above statement would fail for an unallocated object, because the assignment</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">! has been overloaded using a nonallocatable first dummy argument</span></span></code></pre></div>
<p>A caveat is that for <em>overloaded</em> assignment, this will
usually not work - either one needs to explicitly allocate the object
before assigning to it, or sourced allocation must be used, which
bypasses the overloaded assignment.</p>
<p>Note that for allocatable objects with deferred-size entries (e.g.,
strings, arrays) a non-conformable left-hand side in an assignment
statement will be deallocated before being allocated to the right length
or shape, respectively.</p>
<p><em>Hint:</em> The features discussed in this subsection are also
useful for object-oriented programming, with additional semantics
applying for the case of polymorphic objects.</p>
<h2 data-number="7.2" id="implementing-move-semantics"><span
class="header-section-number">7.2</span> Implementing move
semantics</h2>
<p>Sometimes it may be necessary to make use of move instead of copy
semantics i.e., create a copy of an object and then getting rid of the
original. The simplest way of doing this is to make use of allocatable
(scalar or array) objects,</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> my_list, your_list</span></code></pre></div>
<p>After <code>your_list</code> has been set up, the object’s content
can then be transferred to <code>my_list</code> by using the
<code>move_alloc</code> intrinsic,</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> move_alloc(your_list, my_list)</span></code></pre></div>
<p>which will deallocate <code>my_list</code> if necessary, before doing
the transfer. After the invocation, <code>my_list</code> will have the
value formerly stored in <code>your_list</code>, and
<code>your_list</code> will end up in the deallocated state. Note that
the latter does not involve a regular object deallocation (effectively,
a descriptor for the object is moved), so any existing finalizer will
not be invoked.</p>
<h2 data-number="7.3" id="the-block-construct"><span
class="header-section-number">7.3</span> The <code>BLOCK</code>
construct</h2>
<p>The above rules on finalization imply that variables declared in the
specification part of the main program are not finalizable, since they
by default have the <code>SAVE</code> attribute. One could argue this is
not necessary since all assigned memory is reclaimed when program
execution ends. However, excessive memory consumption or the use of
other resources may cause issues for reliable program execution. To work
around these, the <code>BLOCK</code> construct can be used:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PROGRAM</span> test_sorted_list</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">USE</span> mod_sortable</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">USE</span> mod_sorted_list</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IMPLICIT</span> <span class="kw">none</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>   :</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>   work : <span class="kw">BLOCK</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">TYPE(sortable)</span> <span class="dt">::</span> array(items)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> my_list, ...</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>      : <span class="co">! initialize array</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      my_list <span class="kw">=</span> sorted_list(array)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>      :</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END BLOCK</span> work  <span class="co">! finalizer is executed on my_list, ...</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>   :</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="kw">END PROGRAM</span></span></code></pre></div>
<p>The construct (as the only one in Fortran) permits declaration of
non-saved variables in its specification part. Their lifetime ends when
program execution reaches the <code>END BLOCK</code> statement, and they
therefore are finalized at this point, if applicable. Named variables
declared outside the construct are accessible inside it, unless a
block-local declaration with the same name exists.</p>
<p><em>Hint:</em> Note that the construct’s execution flow can be
modified by executing an <code>EXIT</code> statement in its body; this
can, for example, be used for structured error handling and finally
permits sending <code>GO TO</code> to retirement.</p>
<h2 data-number="7.4" id="the-associate-construct"><span
class="header-section-number">7.4</span> The <code>ASSOCIATE</code>
construct</h2>
<p>With the introduction of deeply nested derived types, code that needs
access to ultimate components can become quite hard to read. An
<code>ASSOCIATE</code> block construct that enables the use of
auto-typed aliases can be used. This is illustrated by a procedure that
is used to implement the multiplication of two polynomials:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="dt">TYPE(polynomial)</span> <span class="kw">FUNCTION</span> multiply_polynomial(p1, p2)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(polynomial)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> p1, p2</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span> <span class="dt">::</span> j, l, lmax</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>   lmax <span class="kw">=</span> <span class="fu">ubound</span>(p1<span class="op">%</span>a,<span class="dv">1</span>) <span class="kw">+</span> <span class="fu">ubound</span>(p2<span class="op">%</span>a,<span class="dv">1</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ALLOCATE</span>( multiply_polynomial<span class="op">%</span>a(<span class="dv">0</span>:lmax) )</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ASSOCIATE</span>( a <span class="kw">=</span><span class="op">&gt;</span> p1<span class="op">%</span>a, b <span class="kw">=</span><span class="op">&gt;</span> p2<span class="op">%</span>a, c <span class="kw">=</span><span class="op">&gt;</span> multiply_polynomial<span class="op">%</span>a, <span class="kw">&amp;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>              jmax <span class="kw">=</span><span class="op">&gt;</span> <span class="fu">ubound</span>(p1<span class="op">%</span>a,<span class="dv">1</span>), kmax <span class="kw">=</span><span class="op">&gt;</span> <span class="fu">ubound</span>(p2<span class="op">%</span>a,<span class="dv">1</span>) )  <span class="co">! association list</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">DO</span> l <span class="kw">=</span> <span class="dv">0</span>, lmax</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>         c(l) <span class="kw">=</span> <span class="dv">0</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>         <span class="kw">DO</span> j <span class="kw">=</span> <span class="bu">max</span>(<span class="dv">0</span>, l<span class="kw">-</span>kmax), <span class="bu">min</span>(jmax, l)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            c(l) <span class="kw">=</span> c(l) <span class="kw">+</span> a(j) <span class="kw">*</span> b(l<span class="kw">-</span>j)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>         <span class="kw">END DO</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END DO</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END ASSOCIATE</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span></span></code></pre></div>
<p>For the duration of execution of the construct, the associate names
can be used to refer to their selectors (i.e., the right-hand sides in
the association list). If the selectors are variables, so are the
associate names (<code>a</code>, <code>b</code>, <code>c</code> in the
above example), and can be assigned to. If the selectors are
expressions, so are the associate names (<code>jmax</code>,
<code>kmax</code> in the above example).</p>
<p>Associated entities that refer to variables inherit the
<code>DIMENSION</code>, <code>CODIMENSION</code>, <code>TARGET</code>,
<code>ASYNCHRONOUS</code> and <code>VOLATILE</code> attributes from
their selectors, but no others. An associate name can only refer to an
<code>OPTIONAL</code> dummy argument if the latter is present. Associate
names can also appear in other block constructs
(<code>SELECT TYPE</code>, <code>CHANGE TEAM</code>), which will be
discussed where appropriate.</p>
<h1 data-number="8"
id="performing-io-with-objects-of-container-like-type"><span
class="header-section-number">8</span> Performing I/O with objects of
container-like type</h1>
<p>For objects of container-like type, a data transfer statement</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(sorted_list)</span> <span class="dt">::</span> my_list</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>: <span class="co">! set up my_list</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">WRITE(*</span>, <span class="fu">*)</span> my_list</span></code></pre></div>
<p>would fail to compile, since the run-time library is incapable of
dealing with the irregular structures that are hiding behind the
innocuous variable. Language features for user-defined derived type I/O
(<strong>UDDTIO</strong>) permit the programmer to control the data
transfer in an appropriate manner. This is achieved by binding an I/O
statement on a derived-type object to a user-defined procedure, for
example through a suitably written named interface:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> <span class="fu">WRITE(formatted)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> write_fmt_list</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>Note that this also applies to data types for which the above
stand-alone statement is permitted, and then overloads the default I/O
mechanism.</p>
<p>Once the binding is properly defined, the above I/O statement is
accepted by the compiler, and its execution causes the user-defined
procedure to be invoked. Therefore it is called the
<strong>parent</strong> I/O statement. The actual data transfer
statements that are issued inside the user-defined procedure are called
<strong>child</strong> I/O statements.</p>
<p>The following interface variants are permitted, with the obvious
interpretation:</p>
<ul>
<li><code>WRITE(formatted)</code></li>
<li><code>READ(formatted)</code></li>
<li><code>WRITE(unformatted)</code></li>
<li><code>READ(unformatted)</code></li>
</ul>
<p>The self-defined procedure is restricted with respect to its
interfaces’ characteristics, which are described in the following:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> <span class="op">&lt;</span>formatted_io<span class="op">&gt;</span>   (dtv, unit, iotype, v_list, iostat, iomsg)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> <span class="op">&lt;</span>unformatted_io<span class="op">&gt;</span> (dtv, unit,                 iostat, iomsg)</span></code></pre></div>
<p>The placeholders <code>&lt;formatted_io&gt;</code> and
<code>&lt;unformatted_io&gt;</code> must be replaced by a specific
procedure name referenced in the generic interface.</p>
<p>The dummy arguments’ declarations and meaning are:</p>
<ul>
<li><p><code>dtv</code>: Must be declared to be a nonpointer
nonallocatable scalar of the type in question. If the type is extensible
(to be explained later), the declaration must be polymorphic (i.e. using
<code>CLASS</code>), otherwise non-polymorphic (using
<code>TYPE</code>). Its <code>INTENT</code> must be <code>in</code> for
<code>WRITE(...)</code>, and “<code>out</code>” or “<code>inout</code>”
for <code>READ(...)</code>. It represents the object on which data
transfer statements are to be executed.</p>
<p><em>Hint:</em> Note: For the examples in this chapter, we need to use
<code>CLASS</code>, but the behaviour is as if <code>TYPE</code> were
used, as long as the actual arguments are non-polymorphic and the
procedure-based interface is used for the invocation.</p></li>
<li><p><code>unit</code>: An <code>INTEGER</code> scalar with
<code>INTENT(in)</code>. Its value is that of the unit used for data
transfer statements. Use of other unit values is not permitted (except,
perhaps, <code>error_unit</code> for debugging purposes).</p></li>
<li><p><code>iotype</code>: A <code>CHARACTER(len=*)</code> string with
<code>INTENT(in)</code>. This can only appear in procedures for
formatted I/O. The following table describes how the incoming value
relates to the parent I/O transfer statement:</p></li>
</ul>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr>
<th>Value</th>
<th>Caused by parent I/O statement</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>"LISTDIRECTED"</code></td>
<td><code>WRITE(unit, fmt=*) my_list</code></td>
</tr>
<tr>
<td><code>"NAMELIST"</code></td>
<td><code>WRITE(unit, nml=my_namelist)</code> <strong>Note:</strong>
Referring to the example, at least one <code>sorted_list</code> object
must be a member of <code>my_namelist</code>.</td>
</tr>
<tr>
<td><code>"DTsorted_list_fmt"</code></td>
<td><code>WRITE(unit, fmt='(DT"sorted_list_fmt"(10,2))') my_list</code>
<strong>Note:</strong> <code>DT</code> is the “derived type” edit
descriptor that is needed in format-driven editing to trigger execution
of the UDDTIO routine. The string following the <code>DT</code> edit
descriptor can be freely chosen (even to be zero length); it is
recommended that the UDDTIO procedure pay attention to any possible
values supplied in the parent I/O statement if it supports DT
editing.</td>
</tr>
</tbody>
</table>
<ul>
<li><code>v_list</code>: A rank-1 assumed-shape <code>INTEGER</code>
array with <code>INTENT(in)</code> . This can only appear in procedures
for formatted I/O. The incoming value is taken from the final part of
the <code>DT</code> edit descriptor; in the example from the table above
it would have the value <code>[10,2]</code>. Free use can be made of the
value for the disposition (formatting, controlling) of I/O transfer
statements inside the procedure. The array’s size may be zero;
specifically, it will be of size zero for the listdirected or namelist
cases.</li>
<li><code>iostat</code>: An <code>INTEGER</code> scalar with
<code>INTENT(out)</code>. It must be given a value consistent with those
produced by non-UDTTIO statements in case of an error. Successful
execution of the I/O must result in a zero value. Unsuccessful execution
must result in either a positive value, or one of the values
<code>iostat_end</code> or <code>iostat_eor</code> from the
<code>iso_fortran_env</code> intrinsic module.</li>
<li><code>iomsg</code>: A <code>CHARACTER(len=*)</code> string with
<code>INTENT(inout)</code>. It must be given a value if a non-zero
<code>iostat</code> is returned.</li>
</ul>
<p>Additional properties and restrictions for UDDTIO are:</p>
<ul>
<li>All data transfers are executed in non-advancing mode. Any
<code>advance=</code> specifier will be ignored;</li>
<li>asynchronous I/O is not supported;</li>
<li>Inside the user-defined routine, no file positioning statements are
permitted.</li>
</ul>
<p>The following demonstrates a partial implementation of formatted
writing on <code>sorted_list</code> objects:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RECURSIVE</span> <span class="kw">SUBROUTINE</span> write_fmt_list(dtv, unit, iotype, v_list, iostat, iomsg)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(sorted_list)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> dtv</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> unit, v_list(:)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=*)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> iotype</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span>, <span class="dt">INTENT(out)</span> <span class="dt">::</span> iostat</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=*)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> iomsg</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=2)</span> <span class="dt">::</span> next_component</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">associated</span>(dtv<span class="op">%</span>next) ) <span class="kw">THEN</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">WRITE(</span>next_component, <span class="fu">fmt</span><span class="kw">=</span><span class="st">&#39;(&quot;T,&quot;)&#39;</span><span class="fu">)</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ELSE</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">WRITE(</span>next_component, <span class="fu">fmt</span><span class="kw">=</span><span class="st">&#39;(&quot;F&quot;)&#39;</span><span class="fu">)</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT CASE</span> (iotype)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">CASE</span> (<span class="st">&#39;LISTDIRECTED&#39;</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">WRITE(unit</span>, <span class="fu">fmt</span><span class="kw">=</span><span class="fu">*</span>, <span class="fu">delim</span><span class="kw">=</span><span class="st">&#39;quote&#39;</span>, <span class="fu">iostat</span><span class="kw">=</span><span class="fu">iostat</span>, iomsg<span class="kw">=</span>iomsg<span class="fu">)</span> <span class="kw">&amp;</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>            dtv<span class="op">%</span>data<span class="op">%</span>string</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">CASE</span> (<span class="st">&#39;NAMELIST&#39;</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">WRITE(unit</span>, <span class="fu">fmt</span><span class="kw">=</span><span class="fu">*</span>, <span class="fu">iostat</span><span class="kw">=</span><span class="fu">iostat</span>, iomsg<span class="kw">=</span>iomsg<span class="fu">)</span> <span class="st">&#39;&quot;&#39;</span>, <span class="kw">&amp;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>            dtv<span class="op">%</span>data<span class="op">%</span>string, <span class="st">&#39;&quot;,&#39;</span>, <span class="fu">trim</span>(next_component)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>   <span class="kw">CASE default</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>      iostat <span class="kw">=</span> <span class="dv">129</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>      iomsg <span class="kw">=</span> <span class="st">&#39;iotype &#39;</span> <span class="kw">//</span> <span class="fu">trim</span>(iotype) <span class="kw">//</span> <span class="st">&#39; not implemented&#39;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RETURN</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END SELECT</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">associated</span>(dtv<span class="op">%</span>next) ) <span class="kw">THEN</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> write_fmt_list(dtv<span class="op">%</span>next, unit, iotype, v_list, iostat, iomsg)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>The namelist itself is inaccessible from the procedure; it is not
needed since the procedure only needs to write the list values in a
suitably formatted way. Termination of the list is indicated by a final
logical value of <code>F</code> in the list entry of the namelist file;
the termination information must be appropriately processed in the
corresponding namelist case of the read procedure.</li>
<li>The example implementation does not support <code>DT</code> editing;
invoking the parent I/O statement from the above table would therefore
cause error termination unless an <code>iostat=</code> argument is added
to it.</li>
</ul>
<h1 data-number="9" id="object-oriented-programming-techniques"><span
class="header-section-number">9</span> Object-oriented programming
techniques</h1>
<h1 data-number="10"
id="introduction-establishing-an-explicit-relationship-between-types"><span
class="header-section-number">10</span> Introduction: Establishing an
explicit relationship between types</h1>
<p>The discussion on object-based program design in the previous chapter
was based on creating derived types that are comprised of objects of
other types (intrinsic or derived); this is also known as
<strong>type</strong> <strong>composition</strong> (not a Fortran term).
For object-oriented programming, the approach is that a closer
relationship between two (or maybe more) types can be established
through language-defined mechanisms, on both the levels of type
definition and object declaration and use. Fortran supports a
<strong>single inheritance</strong> model, which will be outlined in the
following sections; runnable example codes are supplied in the
<code>object_oriented</code> subfolder of the <a
href="https://github.com/reinh-bader/object_fortran">Github
repository</a></p>
<h1 data-number="11" id="extension-types"><span
class="header-section-number">11</span> Extension types</h1>
<p>As a starting point, consider the definition of a type, an object of
which can quite generally represent a physical body:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> body</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> mass</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> pos(<span class="dv">3</span>), vel(<span class="dv">3</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(body)</span> <span class="dt">::</span> my_basketball <span class="kw">=</span> body(<span class="fl">1.5</span>, <span class="kw">[</span><span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.0</span><span class="kw">]</span>, <span class="kw">[</span><span class="fl">10.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="kw">]</span>)</span></code></pre></div>
<p>This might come along with procedures that impose a momentum change
or a change of mass on a <code>body</code> object:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="kw">SUBROUTINE</span> kick(a_body, dp)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(body)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> a_body</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">intent(in)</span> <span class="dt">::</span> dp(<span class="dv">3</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>   a_body<span class="op">%</span>vel(:) <span class="kw">=</span> a_body<span class="op">%</span>vel(:) <span class="kw">+</span> dp(:) <span class="kw">/</span> a_body<span class="op">%</span>mass</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="kw">SUBROUTINE</span> accrete(a_body, dm)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(body)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> a_body</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">intent(in)</span> <span class="dt">::</span> dm</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>   a_body<span class="op">%</span>mass <span class="kw">=</span> a_body<span class="op">%</span>mass <span class="kw">+</span> dm</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span> accrete</span></code></pre></div>
<p>After writing lots of code that makes use of the above, imagine that
you now want to deal with objects that have the additional property of
electric charge. One could, of course, simply add another component to
the original <code>body</code> type, but in most cases this would
invalidate existing code which would need to be corrected, recompiled
and retested. Furthermore, all <code>body</code> objects would require
the extra memory, which for the existing codebase would simply be
wasted. It is more convenient and less intrusive to create a new type
that is an <strong>extension</strong> of the existing one (the
<strong>parent</strong> type):</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">EXTENDS(body)</span> <span class="dt">::</span> charged_body</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> charge</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>An object of this type</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(charged_body)</span> <span class="dt">::</span> a_proton</span></code></pre></div>
<p>would then have the following type components:</p>
<ul>
<li><code>a_proton%mass</code></li>
<li><code>a_proton%pos</code></li>
<li><code>a_proton%vel</code></li>
</ul>
<p>that are <strong>inherited</strong> from the parent type, and the
additional type component</p>
<ul>
<li><code>a_proton%charge</code></li>
</ul>
<p>that was added in the definition of <code>charged_body</code>.
Furthermore, it is also possible to reference that part of the object
corresponding to the parent type, which is a subobject of just that
type:</p>
<ul>
<li><code>a_proton%body</code></li>
</ul>
<p>Correspondingly, there are various manners in which the default
structure constructor can be used to create a defined value:</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(body)</span> <span class="dt">::</span> a_mutilated_proton</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">! Construct a_proton</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>a_proton <span class="kw">=</span> charged_body(mass<span class="kw">=</span><span class="fl">1.672</span>E<span class="kw">-</span><span class="dv">27</span>, pos<span class="kw">=[</span><span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="kw">]</span>, <span class="kw">&amp;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                        vel<span class="kw">=[</span><span class="fl">0.0</span> ,<span class="fl">0.0</span>, <span class="fl">0.0</span><span class="kw">]</span>), charge<span class="kw">=</span><span class="fl">1.602</span>E<span class="kw">-</span><span class="dv">19</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">! Alternative construction with the same result</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>a_mutilated_proton <span class="kw">=</span> body(mass<span class="kw">=</span><span class="fl">1.672</span>E<span class="kw">-</span><span class="dv">27</span>, pos<span class="kw">=[</span><span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="kw">]</span>, <span class="kw">&amp;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                          vel<span class="kw">=[</span><span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="kw">]</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>a_proton <span class="kw">=</span> charged_body(body<span class="kw">=</span>a_mutilated_proton, charge<span class="kw">=</span><span class="fl">1.602</span>E<span class="kw">-</span><span class="dv">19</span>)</span></code></pre></div>
<p>Any derived type that does not have the <code>SEQUENCE</code> or
<code>BIND(C)</code> attributes can be extended in the above manner;
specifically, an extension type can itself be extended. For any given
“base” type this gives rise to a potential hierarchy of types that can
be represented by a directed acyclical graph:</p>
<figure>
<img src="./images/Inheritance_diagram.png" style="width:3in" alt=" " />
<figcaption aria-hidden="true"> </figcaption>
</figure>
<p>An object of type <code>body</code> is <strong>type
compatible</strong> with both <code>a_proton</code> and
<code>a_mutilated_proton</code>, so any of these two can, for example,
appear in a call to the procedure <code>kick</code>.</p>
<h1 data-number="12" id="polymorphism"><span
class="header-section-number">12</span> Polymorphism</h1>
<h2 data-number="12.1" id="declaring-entities-with-class"><span
class="header-section-number">12.1</span> Declaring entities with
<code>CLASS</code></h2>
<p>By declaring an object with the <code>CLASS</code> instead of the
<code>TYPE</code> specifier, is is possible to defer the actual type
that an object has to be determined when the program executes, or even
have the actual type change during program execution. Such an object is
designated as being <strong>polymorphic</strong>. To be polymorphic, an
object must fulfill one of the following prerequisites:</p>
<ul>
<li>it has the <code>POINTER</code> attribute,</li>
<li>it has the <code>ALLOCATABLE</code> attribute, or</li>
<li>it is a dummy argument (with or without a <code>POINTER</code> or
<code>ALLOCATABLE</code> attribute).</li>
</ul>
<p>For example, the typed alllocation statement executed on a
polymorphic allocatable object</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CLASS(body)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> a_polymorphic_body</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( charged_body <span class="dt">::</span> a_polymorphic_body )</span></code></pre></div>
<p>causes the object <code>a_polymorphic_body</code> that has the
<strong>declared</strong> type <code>body</code> to be allocated with
the <strong>dynamic</strong> type <code>charged_body</code>; in Fortran
nomenclature, the latter term denotes what was referred to above as
“actual” type.</p>
<p><em>Hint:</em> For an unallocated allocatable or a disassociated
pointer the dynamic type is considered to be the same as the declared
type, although this is only useful in very few contexts that do not
require the object to be allocated or associated.</p>
<h2 data-number="12.2" id="run-time-type-and-class-identification"><span
class="header-section-number">12.2</span> Run-time type and class
identification</h2>
<p>Within the scope of the object’s declaration, only the components of
its declared type are accessible. Also, I/O operations on a polymorphic
object are not permitted, unless UDDTIO routines have been defined. One
way to obtain access to the complete object is to use a construct that
permits <strong>run-time type identification</strong> (not a Fortran
term), <code>SELECT TYPE</code>. For example, the I/O statements in</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT TYPE</span> (a_polymorphic_body)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">TYPE IS</span> (body)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;object of type body has value        &#39;</span>, a_polymorphic_body</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">TYPE IS</span> (charged_body)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;object of type charged_body has value&#39;</span>, a_polymorphic_body</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CLASS default</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>   ERROR <span class="kw">STOP</span> <span class="st">&#39;Type extension unsupported in this construct&#39;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="kw">END SELECT</span></span></code></pre></div>
<p>are permitted, since inside the block for each <strong>type
guard</strong> the object is non-polymorphic and of the specified type.
At most one type guard can match the object’s type, and the
corresponding statements are executed; otherwise the
<code>CLASS default</code> section is executed (and the object remains
polymorphic there). A disadvantage of using <code>SELECT TYPE</code> is
that it needs to be appropriately updated whenever an additional type
extension is defined; apart from the maintenance effort this also
requires access to all source code that contain a relevant instance of
the construct. For this reason, type-bound procedures (to be discussed)
should be preferably used to gain access to additional type
components.</p>
<p>For updates of the <code>charge</code> component of a
<code>charged_body</code> object, one now could consider the
following:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> recharge(a_charged_body, dq)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(charged_body)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> a_charged_body</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> dq</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>   a_charged_body<span class="op">%</span>charge <span class="kw">=</span> a_charged_body<span class="op">%</span>charge <span class="kw">+</span> dq</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>However, invoking this subroutine in the usual Fortran 95 style will
not work for the variable <code>a_polymorphic_body</code>, since it
violates the rule that the dummy argument’s declared type must be type
compatible with the actual argument’s declared type. One can work around
this by using a <code>SELECT TYPE</code> construct with <strong>run-time
class identification</strong> (not a Fortran term), based on writing
<strong>class guards</strong> instead of type guards:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT TYPE</span> (a_polymorphic_body)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CLASS IS</span> (charged_body)  <span class="co">! new declared type for a_polymorphic_body</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">CALL</span> recharge(a_polymorphic_body, dq<span class="kw">=</span><span class="fl">1.0e-5</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CLASS default</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;INFO: object a_polymorphic_body was not modified.&#39;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END SELECT</span></span></code></pre></div>
<p>The <code>recharge</code> procedure will then be invoked if the
dynamic type of <code>a_polymorphic_body</code> is
<code>charged_body</code> or an extension of it. The object remains
polymorphic inside the class guard, only its declared type changes to
that specified in the guard. Unless the “lifted” declared type of
interest is already otherwise known from the context, or handling the
<code>CLASS default</code> fall-through is straightforward, this is not
in general a desirable way of dealing with class mismatches.</p>
<p><em>Hint:</em> It is permitted to mix type and class guards in a
<code>SELECT TYPE</code> construct; in that case, a type guard has
precedence over a class guard specifying the same type with respect to
selection of the guarded statements to be executed.</p>
<h2 data-number="12.3" id="unlimited-polymorphic-objects"><span
class="header-section-number">12.3</span> Unlimited polymorphic
objects</h2>
<p>A special case of polymorphism is that an object can be
<strong>unlimited polymorphic</strong>. Such an object, declared with
<code>CLASS(*)</code>, can be of any dynamic type (intrinsic type,
extensible derived type, <code>SEQUENCE</code> or <code>BIND(C)</code>
derived type), as illustrated by the following statements:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CLASS(*)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> a_unlimited  <span class="co">! has no declared type, so any type is an extension</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( a_unlimited, source<span class="kw">=</span><span class="fl">2.5</span>E4)  <span class="co">! dynamic type becomes real</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT TYPE</span> ( a_unlimited )</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">TYPE IS</span> (<span class="dt">REAL</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;a_unlimited is of intrinsic real type with value &#39;</span>, a_unlimited</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="kw">END SELECT</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="kw">DEALLOCATE</span>( a_unlimited )</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ALLOCATE</span>( a_unlimited, source<span class="kw">=</span>a_proton) )  <span class="co">! dynamic type becomes charged_body</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT TYPE</span> ( a_unlimited )</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="kw">TYPE IS</span> (charged_body)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;a_unlimited is a charged_body with value &#39;</span>, a_unlimited</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="kw">END SELECT</span></span></code></pre></div>
<p>Accessing the object’s data <em>always</em> needs a
<code>SELECT TYPE</code> construct; type guards in the construct can in
this case might not only refer to extensible types, but also to
intrinsic types. However, for <code>SEQUENCE</code> or
<code>BIND(C)</code> derived types, no type resolution is possible -
these always fall through to a <code>CLASS default</code> guard, if
present; use of unlimited polymorphic objects to store values of such
types is therefore considered unsafe.</p>
<p>In this context, allocation with <code>source=</code> allocates the
target object to the source object’s dynamic type before copying its
value to the target object. If the source object’s data is not needed,
<code>mold=</code> can be used instead. Sourced allocation becomes a
powerful tool, since the dynamic type of the source object need not be
known in the scoping unit within which the allocation is executed.</p>
<p>Type components with the <code>POINTER</code> or
<code>ALLOCATABLE</code> attribute can be unlimited polymorphic,
enabling the construction of generic and potentially inhomogeneous
container-like types. As an illustration of this, a supporting type for
the purpose of holding data targeted for manipulation of other objects
is presented; its definition (placed in the module
<code>mod_utility_types</code>) reads</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> any_object</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=:)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> description</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> <span class="dt">value</span>(:)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">INTEGER</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> <span class="fu">shape</span>(:)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>where <code>description</code> will refer to the property that needs
updating, and <code>value</code> will contain the data to be used for
the transaction. Because the <code>value</code> component should be able
to represent any type, it is declared as being unlimited polymorphic.
Because the <code>value</code> component might hold data needed to
produce an array of arbitrary shape, the additional <code>shape</code>
component is supplied, but its use is really only necessary if objects
of rank at least 2 must be dealt with. The structure constructor for
that type has been overloaded to work around compiler bugs and make
handling of scalar data easier. The following example illustrates how to
establish a simple interface for setting components of a structure:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">MODULE</span> mod_wtype</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">USE</span> mod_utility_types, <span class="kw">ONLY</span> : initialize <span class="kw">=</span><span class="op">&gt;</span> any_object</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE</span> <span class="dt">::</span> wtype</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">PRIVATE</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">INTEGER</span> <span class="dt">::</span> nonzeros <span class="kw">=</span> <span class="kw">-</span><span class="dv">1</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> w(:,:)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>   <span class="dt">END TYPE</span> wtype</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SUBROUTINE</span> setup_wtype(a_wtype, a_component)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">! in-place setting to avoid memory bursts for large objects</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">TYPE(wtype)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> a_wtype</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">TYPE(initialize)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">TARGET</span> <span class="dt">::</span> a_component</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">INTEGER</span> <span class="dt">::</span> wsize</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span>, <span class="dt">POINTER</span> <span class="dt">::</span> pw(:,:)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT CASE</span> (a_component<span class="op">%</span>description)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CASE</span> (<span class="st">&quot;nonzeros&quot;</span>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>         <span class="kw">IF</span> ( <span class="fu">allocated</span>(a_component<span class="op">%</span><span class="dt">value</span>) ) <span class="kw">THEN</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">SELECT TYPE</span> ( nonzeros <span class="kw">=</span><span class="op">&gt;</span> a_component<span class="op">%</span><span class="dt">value</span>(<span class="dv">1</span>) )</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">TYPE IS</span> (<span class="dt">INTEGER</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>               a_wtype<span class="op">%</span>nonzeros <span class="kw">=</span> nonzeros</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">END SELECT</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>         <span class="kw">END IF</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CASE</span> (<span class="st">&quot;w&quot;</span>)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>         <span class="kw">IF</span> ( <span class="fu">allocated</span>(a_component<span class="op">%</span><span class="dt">value</span>) <span class="op">.AND.</span> <span class="fu">allocated</span>(a_component<span class="op">%</span><span class="fu">shape</span>) ) <span class="kw">THEN</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>            wsize <span class="kw">=</span> <span class="fu">size</span>(a_component<span class="op">%</span><span class="dt">value</span>)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">IF</span> ( wsize <span class="op">&gt;=</span> <span class="fu">product</span>(a_component<span class="op">%</span><span class="fu">shape</span>) ) <span class="kw">THEN</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>               <span class="kw">SELECT TYPE</span> ( w <span class="kw">=</span><span class="op">&gt;</span> a_component<span class="op">%</span><span class="dt">value</span> )</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>               <span class="kw">TYPE IS</span> (<span class="dt">REAL</span>)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>                  pw(<span class="dv">1</span>:a_component<span class="op">%</span><span class="fu">shape</span>(<span class="dv">1</span>), <span class="dv">1</span>:a_component<span class="op">%</span><span class="fu">shape</span>(<span class="dv">2</span>)) <span class="kw">=</span><span class="op">&gt;</span> w</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>                  a_wtype<span class="op">%</span>w <span class="kw">=</span> pw</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>               <span class="kw">END SELECT</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">END IF</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>         <span class="kw">END IF</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END SELECT</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END SUBROUTINE</span> setup_wtype</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>   :</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a><span class="kw">END MODULE</span></span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>Having this simple interface at the cost of significant additional
setup code might at first sight appear frivolous; however, once type
extension is used on a larger scale, setting or modifying further
components in the conventional way becomes rather irksome without a
concept like that above, especially if <a href="#sec:tbp">type-bound
procedures</a> with a simple <em>and</em> uniform interface must be
implemented;</li>
<li>The object <code>a_wtype</code> remains unchanged in case an
unsuitable value is provided for <code>a_component</code>. One could add
explicit error handling, but for these examples this is considered an
unnecessary complication;</li>
<li>The permitted values for the <code>initialize</code> object should
be documented for each procedure that takes such an object;</li>
<li>Because access to <code>a_component</code> within
<code>SELECT TYPE</code> is via a type component, one is obliged to
introduce an associate name for the latter. The language rules only
permit omitting the associate name for named variables, and subobjects
are not named variables;</li>
<li>A <strong>rank-changing pointer assignment</strong> is used to
transform the rank-1 <code>a_component%value</code> array to an object
that can be assigned to a rank-2 <code>a_wtype%w</code> array; this
works because the right-hand side is a rank-1 object; for rank-2 and
higher the rank-changing pointer assignment will only work if the target
assigned to is a <strong>simply contiguous array designator</strong> (a
topic not covered here). Note that in this context, the
<code>reshape</code> intrinsic cannot be used because it requires the
size of its <code>shape</code> argument to be a constant.</li>
</ul>
<p>The program invoking the <code>setup_wtype</code> procedure might do
so as follows, to set up a <code>wtype</code> object:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> mod_wtype</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(initialize)</span> <span class="dt">::</span> c_nz, c_w</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(wtype)</span> <span class="dt">::</span> my_wtype</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="dt">INTEGER</span> <span class="dt">::</span> i, j</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="dt">INTEGER</span> <span class="dt">::</span> ndim</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>ndim <span class="kw">=</span> ...</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ASSOCIATE</span> ( my_data <span class="kw">=</span><span class="op">&gt;</span> <span class="kw">[</span> ((<span class="dt">real (max(0, min(i-j+2, j-i+2)))</span>, j<span class="kw">=</span><span class="dv">1</span>, ndim), i<span class="kw">=</span><span class="dv">1</span>, ndim) <span class="kw">]</span> )</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>   c_nz <span class="kw">=</span> initialize(<span class="st">&quot;nonzeros&quot;</span>, <span class="fu">count</span>(my_data <span class="op">/=</span> <span class="dv">0</span>))</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>   c_w <span class="kw">=</span> initialize(<span class="st">&quot;w&quot;</span>, my_data, <span class="kw">[</span> ndim, ndim <span class="kw">]</span> )</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="kw">END ASSOCIATE</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> setup_wtype(my_wtype, c_nz)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> setup_wtype(my_wtype, c_w)</span></code></pre></div>
<h1 data-number="13" id="sec:tbp"><span
class="header-section-number">13</span> Type-bound procedures (TBP)</h1>
<p>To resolve the class mismatch issues arising from the use of
polymorphic objects, one needs a language mechanism for making a
run-time decision on a procedure invocation that depends on the dynamic
type of a polymorphic object. This can be achieved by binding a
procedure to a type in the type definition via a <code>PROCEDURE</code>
statement in the type’s <code>CONTAINS</code> part.</p>
<p>For the type <code>body</code>, the augmented type definition
reads</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span> <span class="dt">::</span> body</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> mass</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> pos(<span class="dv">3</span>), vel(<span class="dv">3</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE</span> <span class="dt">::</span> update <span class="kw">=</span><span class="op">&gt;</span> update_body</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>This does not impact how the structure constructor is used; for this,
only the specifications before the <code>CONTAINS</code> statement are
relevant. To establish a simple and uniform interface for object
updates, the procedure <code>update_body</code> makes use of the
<code>any_object</code> type discussed earlier, which in view of the
context is locally renamed to <code>change</code>:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> update_body(a_body, a_change)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(body)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> a_body</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(change)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> a_change</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">allocated</span>(a_change<span class="op">%</span>description) <span class="op">.AND.</span> <span class="fu">allocated</span>(a_change<span class="op">%</span><span class="dt">value</span>) ) <span class="kw">THEN</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>     <span class="kw">SELECT CASE</span> ( <span class="fu">trim</span>(a_change<span class="op">%</span>description) )</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CASE</span> (<span class="st">&#39;mass&#39;</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT TYPE</span> ( delta <span class="kw">=</span><span class="op">&gt;</span> a_change<span class="op">%</span><span class="dt">value</span>(<span class="dv">1</span>) )</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">TYPE IS</span> (<span class="dt">real</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>           <span class="kw">CALL</span> accrete(a_body, delta)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">END SELECT</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CASE</span> (<span class="st">&#39;momentum&#39;</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT TYPE</span> ( delta <span class="kw">=</span><span class="op">&gt;</span> a_change<span class="op">%</span><span class="dt">value</span> )</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">TYPE IS</span> (<span class="dt">real</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>           <span class="kw">IF</span> ( <span class="fu">size</span>(delta) <span class="op">&gt;=</span> <span class="dv">3</span> ) <span class="kw">CALL</span> kick(a_body, delta(<span class="dv">1</span>:<span class="dv">3</span>))</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">END SELECT</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CASE</span> (<span class="st">&#39;position&#39;</span>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT TYPE</span> ( delta <span class="kw">=</span><span class="op">&gt;</span> a_change<span class="op">%</span><span class="dt">value</span> )</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">TYPE IS</span> (<span class="dt">real</span>)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>           <span class="kw">IF</span> ( <span class="fu">size</span>(delta) <span class="op">&gt;=</span> <span class="dv">3</span>) a_body<span class="op">%</span>pos <span class="kw">=</span> a_body<span class="op">%</span>pos <span class="kw">+</span> delta(<span class="dv">1</span>:<span class="dv">3</span>)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">END SELECT</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>     <span class="kw">END SELECT</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>In its interface, the <strong>passed object</strong>
<code>a_body</code> must be declared to be a polymorphic scalar, with
its declared type being the one the procedure has been bound to. The
implementation reuses existing code where possible (very simple in this
example, but this is of course not generally the case), to avoid the
need for extensive revalidation.</p>
<p>Invocation of the procedure could be done in the usual manner, but
the preferred style, especially in the case that the actual argument is
polymorphic, is to do it through the object itself:</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(change)</span> <span class="dt">::</span>  dx</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>:</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>dx <span class="kw">=</span> change(description<span class="kw">=</span><span class="st">&#39;mass&#39;</span>, <span class="dt">value</span><span class="kw">=[</span><span class="fl">0.0</span>, <span class="fl">2.0</span>, <span class="fl">0.0</span><span class="kw">]</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> my_basketball<span class="op">%</span>update(dx) <span class="co">! invokes update_body(my_basketball, dx)</span></span></code></pre></div>
<p>For polymorphic objects, the procedure <code>update_body</code> will
be invoked if the dynamic type of the object is <code>body</code> (this
might not be true if the dynamic type is an extension, as we shall
see).</p>
<p><em>Hint:</em> The invocation can also be done with non-polymorphic
objects; in this case, the binding could (in principle) be determined at
compilation time, potentially saving some call overhead. Note that the
passed object dummy is not permitted to be allocatable or a pointer,
which facilitates this usage.</p>
<p>So far this is not particularly interesting; the key thing is what
happens once we turn to type extensions. For example, to enable
modification of the <code>charge</code> component (in addition to that
of other components) of an object of dynamic type
<code>charged_body</code>, it is possible to <strong>override</strong>
the parent type’s bound procedure:</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">EXTENDS(body)</span> <span class="dt">::</span> charged_body</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> charge</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE</span> <span class="dt">::</span> update <span class="kw">=</span><span class="op">&gt;</span> update_charged_body</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>with the procedure defined as follows:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> update_charged_body(a_body, a_change)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(charged_body)</span> <span class="dt">::</span> a_body</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(change)</span> <span class="dt">::</span> a_change</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">allocated</span>(a_change<span class="op">%</span>description) <span class="op">.AND.</span> <span class="fu">allocated</span>(a_change<span class="op">%</span><span class="dt">value</span>) ) <span class="kw">THEN</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT CASE</span> ( <span class="fu">trim</span>(a_change<span class="op">%</span>description) )</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CASE</span> (<span class="st">&#39;charge&#39;</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>         <span class="kw">SELECT TYPE</span> ( delta <span class="kw">=</span><span class="op">&gt;</span> a_change<span class="op">%</span><span class="dt">value</span>(<span class="dv">1</span>) )</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>         <span class="kw">TYPE IS</span> (<span class="dt">real</span>)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>            a_body<span class="op">%</span>charge <span class="kw">=</span> a_body<span class="op">%</span>charge <span class="kw">+</span> delta</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>         <span class="kw">END SELECT</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CASE default</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>         <span class="kw">CALL</span> a_body<span class="op">%</span>body<span class="op">%</span>update(a_change)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>         <span class="co">! assure that a change to a parent component is dealt with</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END SELECT</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>The overriding procedure must use the same interface as the
overridden procedure, except that the passed object is declared to be of
the extended type; even the argument keywords must be the same. Once the
override has been defined, the call through an object of dynamic type
<code>charged_body</code> will be dispatched to
<code>update_charged_body</code>:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(change)</span> <span class="dt">::</span>  dc, dp</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CLASS(body)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> my_polymorphic_body</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>my_polymorphic_body <span class="kw">=</span> charged_body(mass<span class="kw">=</span><span class="fl">1.5</span>, pos<span class="kw">=[</span><span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span><span class="kw">]</span>, <span class="kw">&amp;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                                   vel<span class="kw">=[</span><span class="fl">2.</span>,<span class="fl">0.</span>,<span class="fl">0.</span><span class="kw">]</span>, charge<span class="kw">=</span><span class="fl">2.41</span>E<span class="kw">-</span><span class="dv">5</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">!  the above statement auto-allocates the left hand side</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>dc <span class="kw">=</span> change(description<span class="kw">=</span><span class="st">&#39;charge&#39;</span>, <span class="dt">value</span><span class="kw">=</span><span class="fl">5.0</span>E<span class="kw">-</span><span class="dv">6</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>dp <span class="kw">=</span> change(description<span class="kw">=</span><span class="st">&#39;momentum&#39;</span>, <span class="dt">value</span><span class="kw">=[-</span><span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span><span class="kw">]</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">! both the following dispatch to update_charged_body</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> my_polymorphic_body<span class="op">%</span>update(dc)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> my_polymorphic_body<span class="op">%</span>update(dp)</span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>for the above example, direct invocation of the procedure
<code>update_charged_body</code> is not possible (as already noted
earlier);</li>
<li>the second TBP call illustrates the invocation of the parent object
update from <code>update_charged_body</code>. Without this, changes that
impact the parent object would not be done. By implementing this
consistency of behaviour, the programmer assures that the inheritance
hierarchy adheres to the <a
href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov
substitution principle</a>;</li>
<li>to enforce using the TBP calls in a use association context, the
module procedures that implement them can be made <code>PRIVATE</code>.
The accessibility of the TBP itself is determined by the attribute for
it (default is <code>PUBLIC</code>) in the type definition;</li>
<li>the programmer can prevent overriding of a binding by declaring it
to be <code>NON_OVERRIDABLE</code>; its implementation then is regarded
as valid for all conceivable extension types.</li>
</ul>
<h1 data-number="14" id="abstract-types-and-interfaces"><span
class="header-section-number">14</span> Abstract types and
interfaces</h1>
<p>The <code>sortable</code> type used for demonstrating the
<code>sortable_list</code> functionality in the <a
href="#sec:oop_techniques">object-based chapter’s</a> example was set up
as a fixed container-like type. It is desirable to be able to use the
list machinery more flexibly i.e., for any type that supports the
“less-than” comparison. This can be achieved by introducing an
<strong>abstract type</strong></p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">ABSTRACT</span> <span class="dt">::</span> sortable</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(compare)</span>, <span class="dt">DEFERRED</span> <span class="dt">::</span> less_than</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">! ... more to follow</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>with a <strong>deferred binding</strong>. It is not possible to
create an object whose dynamic type is abstract, or a non-polymorphic
object of abstract type. For this reason, the deferred binding cannot
represent an existing procedure, but is characterized by an
<strong>abstract interface</strong>:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="dt">ABSTRACT</span> <span class="kw">INTERFACE</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">PURE</span> <span class="dt">LOGICAL</span> <span class="kw">FUNCTION</span> compare(s1, s2)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">IMPORT</span> <span class="dt">::</span> sortable</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">CLASS(sortable)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> s1, s2</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">! dispatch is via the first argument</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END FUNCTION</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>The <code>IMPORT</code> statement is required to give the interface
access to the type defined in its host. Furthermore, an override of the
structure constructor will be needed</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> sortable</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE</span> <span class="dt">::</span> create_sortable</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>that permits creation of polymorphic <code>sortable</code> objects.
The details of this will be described later (since, indeed, a devil
lurks in these details). Note that the above combined use of abstract
types and interfaces is also known under the (non-Fortran) term
<strong>interface class</strong>.</p>
<p>This framework permits the programmer to implement the following
programming technique, which is also known as <strong>dependency
inversion</strong> (not a Fortran term):</p>
<ol type="1">
<li><p>Any machinery that makes use of polymorphic <code>sortable</code>
objects is made to only refer to the above abstractions. For example,
the definition of the <code>sorted_list</code> type could be adapted to
read</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">PUBLIC</span> <span class="dt">::</span> sorted_list</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(sortable)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> data</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">! changed to refer to abstract type</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(sorted_list)</span>, <span class="dt">POINTER</span> <span class="dt">::</span> next <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>   <span class="dt">FINAL</span> <span class="dt">::</span> delete_sorted_list</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div></li>
</ol>
<p>The advantage of this is that no change to the preexisting machinery
will be needed whenever a programmer decides to add an extension type as
outlined in 2. below.</p>
<ol start="2" type="1">
<li><p>For a concrete realization of a <code>sortable</code> object, the
programmer needs to create a type extension, for example</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">PUBLIC</span>, <span class="dt">EXTENDS(sortable)</span> <span class="dt">::</span> sortable_string</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CHARACTER(len=:)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> string</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE</span> <span class="dt">::</span> less_than <span class="kw">=</span><span class="op">&gt;</span> less_than_string</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div></li>
</ol>
<p>including an <em>obligatory</em> implementation
<code>less_than_string</code> of an overriding TBP for the deferred
binding. The constructor function (promised earlier, but not yet
delivered) also needs to be updated to enable creation of objects of the
extended type.</p>
<h1 data-number="15"
id="generic-type-bound-procedures-and-operator-overloading"><span
class="header-section-number">15</span> Generic type-bound procedures
and operator overloading</h1>
<p>As a convenience, use of an overloading for the comparison operator
“&lt;” can be provided by creating a <strong>generic</strong> type-bound
procedure:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">ABSTRACT</span> <span class="dt">::</span> sortable</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(compare)</span>, <span class="dt">DEFERRED</span> <span class="dt">::</span> less_than</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">GENERIC</span> <span class="dt">::</span> <span class="kw">OPERATOR</span>(<span class="op">&lt;</span>) <span class="kw">=</span><span class="op">&gt;</span> less_than</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="dt">END TYPE</span></span></code></pre></div>
<p>which means that when a statement involving a comparison
expression</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CLASS(sortable)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> s1, s2</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>s1 <span class="kw">=</span> sortable( ... )</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>s2 <span class="kw">=</span> sortable( ... )</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="kw">IF</span> ( s1 <span class="op">&lt;</span> s2 ) <span class="kw">THEN</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>   ...</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="kw">END IF</span></span></code></pre></div>
<p>is executed, the overridden type-bound procedure bound to the first
operand will be invoked to evaluate the expression. It is not necessary
to re-specify the <code>GENERIC</code> clause in any type extensions;
the dispatch will automatically select the overridden procedure.</p>
<p>Named generic type-bound procedures that do not overload existing
operations can also be defined; an example for this is given in the
section “<a href="#sec:functions_with_parameters">Functions with
parameters</a>”. The rules for generic resolution work similar as for
nonpolymorphic generic procedure interfaces, with the additional
restriction that polymorphic dummy arguments that are related by
inheritance cannot be distinguished for the purpose of compile-time
resolution to a specific procedure.</p>
<h1 data-number="16" id="completing-the-dependency-inversion"><span
class="header-section-number">16</span> Completing the dependency
inversion</h1>
<h2 data-number="16.1" id="discussion-of-structural-dependencies"><span
class="header-section-number">16.1</span> Discussion of structural
dependencies</h2>
<p>When implementing the above concept, typically a separate module, say
<code>mod_sortable_extensions</code>, is created for some or all of the
extension types of <code>sortable</code>. The motivations for this can
be:</p>
<ul>
<li>avoid recompilation of any machinery that makes use of the
<code>mod_sortable</code> module;</li>
<li>the source code of <code>mod_sortable</code> might not be readily
modifiable;</li>
<li>prevent <code>mod_sortable</code> from turning into a monster module
in case large concepts are implemented through extension types, or many
extension types are created.</li>
</ul>
<p>The implementation of the constructor will need to use associate
<code>mod_sortable_extensions</code> since it needs to be able to create
objects of the types defined there. On the other hand, the interface to
the constructor needs to be visible in <code>mod_sortable</code>, since
the machinery that depends on it must be able to call it. As a
consequence, one would end up with a circular <code>USE</code>
dependency between the two modules, which is prohibited.</p>
<h2 data-number="16.2"
id="using-submodules-to-break-dependency-cycles"><span
class="header-section-number">16.2</span> Using submodules to break
dependency cycles</h2>
<p>To deal with such a situation (among others), the concept of
<strong>submodule</strong> is available. This is a type of program unit
that serves as an extension to an existing module (or submodule), to
which it has access by host association. Furthermore, submodules allow
the programmer to separate interfaces from implementations; the former
are defined in the parent program unit (i.e., the program unit of which
the submodule is an extension), the latter in the submodule itself.</p>
<p>For the constructor function, the following interface block can be
declared in <code>mod_sortable</code>:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE</span> <span class="kw">FUNCTION</span> create_sortable(init) <span class="kw">RESULT</span>(r)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">CLASS(sortable)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> r</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">TYPE(initialize)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> init</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END FUNCTION</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>The special notation <code>MODULE FUNCTION</code> (or
<code>MODULE SUBROUTINE</code> for a subroutine) tells the compiler that
the implementation is deferred to a submodule.</p>
<p><strong>Notes:</strong></p>
<ul>
<li>the above interface requires no reference to any entities contained
in <code>mod_sortable_extensions</code>;</li>
<li>consistent with this, the variable representing the function result
is an allocatable polymorphic object of the abstract type;</li>
<li>an <code>IMPORT</code> statement is not obligatory in separate
module procedure interfaces, although it is permitted (compiler support
assumed!), primarily for the purpose of fine-grain control of host
access;</li>
<li>the type <code>initialize</code> is, again, a renamed version of the
<code>any_object</code> type referred to earlier.</li>
</ul>
<h2 data-number="16.3" id="implementation-of-the-constructor"><span
class="header-section-number">16.3</span> Implementation of the
constructor</h2>
<p>The submodule containing the implementation then reads as
follows:</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBMODULE</span> (mod_sortable) smod_constructor</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> create_sortable</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">USE</span> mod_sortable_extensions, <span class="kw">ONLY</span> : sortable_string</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">IF</span> ( <span class="fu">allocated</span>(init<span class="op">%</span>description) <span class="op">.AND.</span> <span class="fu">allocated</span>(init<span class="op">%</span><span class="dt">value</span>) ) <span class="kw">THEN</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>         <span class="kw">SELECT CASE</span> (init<span class="op">%</span>description)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>         <span class="kw">CASE</span> (<span class="st">&#39;sortable_string&#39;</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">SELECT TYPE</span> ( <span class="dt">value</span> <span class="kw">=</span><span class="op">&gt;</span> init<span class="op">%</span><span class="dt">value</span>(<span class="dv">1</span>) )</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">TYPE IS</span> (<span class="dt">CHARACTER(len=*)</span>)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>               <span class="kw">ALLOCATE</span>( r, source<span class="kw">=</span>sortable_string(<span class="dt">value</span>) )</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">END SELECT</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>         <span class="kw">END SELECT</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END IF</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END PROCEDURE</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBMODULE</span></span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>The interface for the separate module procedures is omitted, since
it can be deduced from its specification in the parent module. However,
alternative syntax exists that replicates the interface (but this is not
shown here);</li>
<li>the effect of the <code>ONLY</code> clause is to suppress use access
to any entity of the parent program unit (which would be indirectly
established). This is because use association overrides host
association, which may cause undesirable side effects;</li>
<li>submodules additionally can contain specifications (before the
<code>CONTAINS</code> statement), as well as local submodule procedures.
All these are only accessible from the submodule (and its descendant
submodules, if any);</li>
<li>the naming scheme for a submodule always references the direct
parent. For submodules of submodules, the scheme is
<code>SUBMODULE (&lt;parent module&gt;:&lt;parent submodule&gt;) &lt;submodule_name&gt;</code>
and the names of submodules of a given module must be unique.</li>
</ul>
<h2 data-number="16.4"
id="diagramming-the-dependencies-between-program-units"><span
class="header-section-number">16.4</span> Diagramming the dependencies
between program units</h2>
<p>The following diagram shows the use and host association
relationships between the modules (blue boxes), the submodule (green
box), and a main program unit (orange box) for this example:</p>
<figure>
<img src="./images/Dependency_inversion.png" style="width:5in"
alt="Dependencies between program units implementing and using an interface class" />
<figcaption aria-hidden="true">Dependencies between program units
implementing and using an interface class</figcaption>
</figure>
<p>The small triangles in the diagram refer to use (“u”) association and
host (“h”) association, respectively. The separation of the
constructor’s interface from its implementation leads to avoidance of
circular <code>USE</code> references (the lower two “u” triangles in the
diagram).</p>
<p>The compilation order for separate files would be:</p>
<ol type="1">
<li><code>mod_sortable</code></li>
<li><code>program</code> and <code>mod_sortable_extensions</code>,
independently</li>
<li><code>smod_constructor</code></li>
</ol>
<h1 data-number="17" id="performance-and-ease-of-use"><span
class="header-section-number">17</span> Performance and ease of use</h1>
<h1 data-number="18" id="sec:functions_with_parameters"><span
class="header-section-number">18</span> Functions with parameters</h1>
<h2 data-number="18.1"
id="a-type-definition-for-invocation-of-a-general-function"><span
class="header-section-number">18.1</span> A type definition for
invocation of a general function</h2>
<p>In scientific applications, a commonly occurring requirement is the
need to evaluate functions that depend on additional parameters, apart
from their real-valued argument. For example, an application might need
the value of spherical Bessel function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>↦</mo><msub><mi>j</mi><mi>l</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>q</mi><mspace width="0.167em"></mspace><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">x \mapsto j_l(q \, x)</annotation></semantics></math>
for independently specified integer values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
and real values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>q</mi><annotation encoding="application/x-tex">q</annotation></semantics></math>.
More generally, one can consider a real-valued mapping</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℜ</mi><mo>∋</mo><mi>x</mi><mo>↦</mo><msub><mi>f</mi><mi>λ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="1.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mi>λ</mi><mo>∈</mo><mi>Ω</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Re \ni x \mapsto f_\lambda(x) \quad (\lambda \in \Omega)</annotation></semantics></math>,</p>
<p>where the parameter value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
can be from some arbitrary set. This section presents a way for handling
this programmatically, using the object-oriented features of Fortran. We
start with the outline for a type definition of sufficient
generality:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">PUBLIC</span> <span class="dt">::</span> pfunc_type</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(pfunc)</span>, <span class="dt">POINTER</span>, <span class="dt">NOPASS</span> <span class="dt">::</span> fp <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>   : <span class="co">! shown later</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> param</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>   : <span class="co">! shown later</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="dt">END type</span> pfunc_type</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="dt">ABSTRACT</span> <span class="kw">INTERFACE</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">PURE</span> <span class="dt">REAL</span> <span class="kw">FUNCTION</span> pfunc(x, param)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END FUNCTION</span> pfunc</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>It supplies</p>
<ul>
<li>a <strong>procedure pointer</strong> component with an abstract
interface that reflects the above mapping;</li>
<li>an unlimited polymorphic parameter component, to keep all things in
one place.</li>
</ul>
<p>Notionally, one could invoke a properly set up
<code>pfunc_type</code> object through</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(pfunc_type)</span> <span class="dt">::</span> pfunc_obj</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="dt">REAL</span> <span class="dt">::</span> x</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>pfunc_obj <span class="kw">=</span> pfunc_type(psin, <span class="dv">2</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co">! definitions of procedure and data object discussed further below</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>x <span class="kw">=</span> ...</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">WRITE(*</span>,<span class="fu">*)</span> <span class="st">&#39;Function value is &#39;</span>, pfunc_obj<span class="op">%</span>fp(x, pfunc_obj<span class="op">%</span>param)</span></code></pre></div>
<p>Use of a procedure pointer reflects the fact that each
<code>pfunc_type</code> object will want to associate its individual
target function; this is sometimes also referred to as an
<strong>object-bound procedure</strong>. The <code>NOPASS</code>
attribute in the type definition is needed because otherwise (analogous
to what we saw for the earlier type-bound procedure examples), the
object through which the invocation is done would be obliged to appear
as a first argument in the abstract interface <code>pfunc</code>; this
would constitute an additional imposition on the implementation of the
supplied functions. On the other hand, the invocation needs to
explicitly specify the <code>param</code> component, making it a bit
unwieldy; the use of <code>pfunc_type</code> objects will be simplified
as we go on.</p>
<h2 data-number="18.2"
id="performance-issues-arising-from-object-oriented-programming"><span
class="header-section-number">18.2</span> Performance issues arising
from object-oriented programming</h2>
<p>Let us look at a target function implementation, in form of a trivial
example
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>sin</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>λ</mi><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sin(\lambda x)</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="dt">REAL</span> <span class="kw">FUNCTION</span> psin(x, param)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> factor</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>   factor <span class="kw">=</span> <span class="fl">1.</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">present</span>(param) ) <span class="kw">THEN</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT TYPE</span> ( param )</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">TYPE IS</span> (<span class="dt">REAL</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>         factor <span class="kw">=</span> param</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">TYPE IS</span> (<span class="dt">INTEGER</span>)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>         factor <span class="kw">=</span> <span class="dt">real(param)</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END SELECT</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>   psin <span class="kw">=</span> <span class="bu">sin</span>(factor<span class="kw">*</span>x)</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> psin</span></code></pre></div>
<p>Given that an application is likely to request a large number of
function values, the following effects would ensue once for each
invocation:</p>
<ul>
<li>function call overhead, and</li>
<li>overhead of run-time type resolution.</li>
</ul>
<p>The resulting performance impact is typical for object-oriented
designs that operate in multitudes on small objects. Making use of an
array-based version of the function</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">PURE</span> <span class="kw">FUNCTION</span> psin_array(x, param) <span class="kw">RESULT</span>(r)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x(:)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> r(<span class="fu">size</span>(x))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> factor</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>   factor <span class="kw">=</span> <span class="fl">1.</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">present</span>(param) ) <span class="kw">THEN</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT TYPE</span> ( param )</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">TYPE IS</span> (<span class="dt">REAL</span>)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>         factor <span class="kw">=</span> param</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">TYPE IS</span> (<span class="dt">INTEGER</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>         factor <span class="kw">=</span> <span class="dt">real(param)</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END SELECT</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>   r <span class="kw">=</span> <span class="bu">sin</span>(factor<span class="kw">*</span>x)  <span class="co">! kernel</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> psin_array</span></code></pre></div>
<p>is desirable, since the overheads specified above only arise
<em>once</em>, and the actual calculational code (marked “kernel” in the
above box) is amenable to array-related compiler optimizations (the
specifics of which depend on both hardware architecture and working set
size).</p>
<h2 data-number="18.3"
id="completing-the-function-type-definition"><span
class="header-section-number">18.3</span> Completing the function type
definition</h2>
<p>The aim now is to proceed to a framework that permits to use both the
scalar and the array versions in a uniform way, thereby making life for
the clients that use the framework easy, while enabling performance
where it is needed.</p>
<p>The full definition of <code>pfunc_type</code>, including its
referenced abstract interfaces, reads</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE</span>, <span class="dt">PUBLIC</span> <span class="dt">::</span> pfunc_type</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PRIVATE</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(pfunc)</span>, <span class="dt">POINTER</span>, <span class="dt">NOPASS</span> <span class="dt">::</span> fp <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(pfunc_array)</span>, <span class="dt">POINTER</span>, <span class="dt">NOPASS</span> <span class="dt">::</span> fp_array <span class="kw">=</span><span class="op">&gt;</span> null()</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">ALLOCATABLE</span> <span class="dt">::</span> param</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE</span>, <span class="dt">PASS</span>, <span class="dt">PRIVATE</span>, <span class="dt">NON_OVERRIDABLE</span> <span class="dt">::</span> f_scalar, f_array</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>   <span class="dt">GENERIC</span> <span class="dt">::</span> f <span class="kw">=</span><span class="op">&gt;</span> f_scalar, f_array</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="dt">END type</span> pfunc_type</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="dt">ABSTRACT</span> <span class="kw">INTERFACE</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>   <span class="kw">PURE</span> <span class="dt">REAL</span> <span class="kw">FUNCTION</span> pfunc(x, param)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END FUNCTION</span> pfunc</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>   <span class="kw">PURE</span> <span class="kw">FUNCTION</span> pfunc_array(x, param) <span class="kw">RESULT</span>(r)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x(:)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">REAL</span> <span class="dt">::</span> r(<span class="fu">size</span>(x))</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END FUNCTION</span> pfunc_array</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span></span></code></pre></div>
<p>Because we now have two procedure pointers in the type (only one of
which is used in each given object), it is advantageous to provide a
generic type-bound procedure <code>f</code> as a front end for ease of
use. The specifics <code>f_scalar</code> and <code>f_array</code> for
this read</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">REAL</span> <span class="kw">FUNCTION</span> f_scalar(this, x)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(pfunc_type)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> this</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">associated</span>(this<span class="op">%</span>fp) ) <span class="kw">THEN</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>      f_scalar <span class="kw">=</span> this<span class="op">%</span>fp(x, this<span class="op">%</span>param)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ELSE</span> <span class="kw">IF</span> ( <span class="fu">associated</span>(this<span class="op">%</span>fp_array) ) <span class="kw">THEN</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ASSOCIATE</span> ( f_array <span class="kw">=</span><span class="op">&gt;</span> this<span class="op">%</span>fp_array(<span class="kw">[</span>x<span class="kw">]</span>, this<span class="op">%</span>param) )</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>         f_scalar <span class="kw">=</span> f_array(<span class="dv">1</span>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">END ASSOCIATE</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ELSE</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>      ERROR <span class="kw">STOP</span> <span class="st">&#39;pfunc_type callback: uninitialized object&#39;</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> f_scalar</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FUNCTION</span> f_array(this, x) <span class="kw">RESULT</span>(r)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(pfunc_type)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> this</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> x(:)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span> <span class="dt">::</span> r(<span class="fu">size</span>(x))</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>   <span class="co">! Note that support for the scalar version is omitted here, since</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>   <span class="co">! the procedure call overhead, including type resolution, would</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>   <span class="co">! significantly impact performance.</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">associated</span>(this<span class="op">%</span>fp_array) ) <span class="kw">THEN</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>      r <span class="kw">=</span> this<span class="op">%</span>fp_array(x, this<span class="op">%</span>param)</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ELSE</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>      ERROR <span class="kw">STOP</span> <span class="st">&#39;pfunc_type callback: uninitialized object&#39;</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> f_array</span></code></pre></div>
<p>The only way to invoke one of these (in a use association context) is
via the generic name, since the specific type-bound procedures have the
<code>PRIVATE</code> attribute; note that <code>pfunc_type</code> is not
designed for being extended. Disambiguation is by rank of
<code>x</code>.</p>
<p>The structure constructor for the type is overloaded</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERFACE</span> pfunc_type</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> create_pfunc_type</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">MODULE PROCEDURE</span> create_pfunc_type_array</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="kw">END INTERFACE</span> pfunc_type</span></code></pre></div>
<p>with the following specific functions:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(pfunc_type)</span> <span class="kw">FUNCTION</span> create_pfunc_type(fp, param)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(pfunc)</span> <span class="dt">::</span> fp</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>   create_pfunc_type<span class="op">%</span>fp <span class="kw">=</span><span class="op">&gt;</span> fp</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">present</span>(param) ) <span class="kw">THEN</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ALLOCATE</span>(create_pfunc_type<span class="op">%</span>param, source<span class="kw">=</span>param)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> create_pfunc_type</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(pfunc_type)</span> <span class="kw">FUNCTION</span> create_pfunc_type_array(fp_array, param)</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>   <span class="dt">PROCEDURE(pfunc_array)</span> <span class="dt">::</span> fp_array</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>   <span class="dt">CLASS(*)</span>, <span class="dt">INTENT(in)</span>, <span class="dt">OPTIONAL</span> <span class="dt">::</span> param</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>   create_pfunc_type_array<span class="op">%</span>fp_array <span class="kw">=</span><span class="op">&gt;</span> fp_array</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">IF</span> ( <span class="fu">present</span>(param) ) <span class="kw">THEN</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ALLOCATE</span>(create_pfunc_type_array<span class="op">%</span>param, source<span class="kw">=</span>param)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">END IF</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="kw">END FUNCTION</span> create_pfunc_type_array</span></code></pre></div>
<p>Disambiguation is possible due to the sufficiently different
interfaces of the procedure arguments.<a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<h2 data-number="18.4" id="using-the-function-type"><span
class="header-section-number">18.4</span> Using the function type</h2>
<p>With the already-shown implementations for the target functions
<code>psin</code> and <code>psin_array</code>, using this framework is
illustrated by the following:</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TYPE(pfunc_type)</span> <span class="dt">::</span> pfunc_obj</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="dt">REAL</span>, <span class="dt">PARAMETER</span> <span class="dt">::</span> piby4 <span class="kw">=</span> <span class="bu">atan</span>(<span class="fl">1.0</span>), <span class="kw">&amp;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>   piby4_arr(<span class="dv">4</span>) <span class="kw">=</span> <span class="kw">[</span> piby4, <span class="fl">2.</span><span class="kw">*</span>piby4, <span class="fl">3.</span><span class="kw">*</span>piby4, <span class="fl">4.</span><span class="kw">*</span>piby4 <span class="kw">]</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>pfunc_obj <span class="kw">=</span> pfunc_type(psin, <span class="fl">2.</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">WRITE(*</span>,<span class="fu">*)</span> pfunc_obj<span class="op">%</span>f(piby4)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>pfunc_obj <span class="kw">=</span> pfunc_type(psin)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="fu">WRITE(*</span>,<span class="fu">*)</span> pfunc_obj<span class="op">%</span>f(piby4)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>pfunc_obj <span class="kw">=</span> pfunc_type(psin_array, <span class="fl">2.</span>)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="fu">WRITE(*</span>,<span class="fu">*)</span> pfunc_obj<span class="op">%</span>f(piby4_arr)</span></code></pre></div>
<p>Omitting a <code>param</code> in a constructor is fine, as long as
the target functions cater for the dummy argument’s non-presence.</p>
<p><em>Hint:</em> The framework’s implementation makes use of the fact
that an unallocated actual argument associated with an
<code>OPTIONAL</code> dummy argument is considered not present. Once
conditional expressions are implemented in compilers, the code will be
appropriately reworked, since use of this feature is recommended
against.</p>
<h1 data-number="19"
id="arrays-of-structures-versus-structures-of-arrays"><span
class="header-section-number">19</span> Arrays of structures versus
structures of arrays</h1>
<p>Returning to our earlier example type body, the next idea would be to
simulate the dynamics of a large ensemble of bodies. A procedure</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode f90"><code class="sourceCode fortranfree"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SUBROUTINE</span> propagate(bodies, delta_t, force_field)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(body)</span>, <span class="dt">INTENT(inout)</span> <span class="dt">::</span> bodies(:)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">REAL</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> delta_t</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">TYPE(field_type)</span>, <span class="dt">INTENT(in)</span> <span class="dt">::</span> force_field</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>   :</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="kw">END SUBROUTINE</span></span></code></pre></div>
<p>might be supplied that modifies the components of all ensemble
members, for example as follows:</p>
<ul>
<li><code>%pos</code>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\longrightarrow</annotation></semantics></math>
<code>%pos + delta_t * %vel</code></li>
<li><code>%vel</code>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\longrightarrow</annotation></semantics></math>
<code>%vel + delta_t * force / %mass</code></li>
</ul>
<p>where <code>force</code> results from evaluating
<code>force_field</code> at the position of the ensemble member.</p>
<h1 data-number="20" id="comments-on-further-language-features"><span
class="header-section-number">20</span> Comments on further language
features</h1>
<h2 data-number="20.1" id="variations-on-the-passed-object"><span
class="header-section-number">20.1</span> Variations on the passed
object</h2>
<p>All examples for type-bound procedures given up to now have the
property that the invoking object itself is passed as the first argument
to the bound procedure. However, this default behaviour can be modified
by the programmer</p>
<ul>
<li>either declaring the binding with a <code>PASS</code> attribute that
references the specific (and of course appropriately declared) procedure
argument the object of the bound type should be passed to,</li>
<li>or declaring the binding with a <code>NOPASS</code> attribute, in
which case the object is not (implicitly) passed to the procedure at all
in a TBP invocation.</li>
</ul>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Metcalf, Michael; Reid, John; Cohen, Malcolm; Bader,
Reinhold (2023). <em>Modern Fortran Explained.</em> Numerical
Mathematics and Scientific Computation. Oxford University Press. <a
href="https://en.wikipedia.org/wiki/Special:BookSources/978-0-19-887657-1">ISBN
978-0-19-887657-1</a>.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Brad Richardson <a
href="https://fortran-lang.discourse.group/t/baders-draft-about-oop-and-fortran-bader-intended-for-wikipedia/8539/3">comments</a>
the two functions are <em>sufficiently different</em> only because their
results differ in rank. This pattern does not necessarily work in the
general case, i.e. that the procedures are not both functions with
different type, kind or rank of their results.</p>
<p>More generally, referring to section 15.4.3.4.5 <em>Restrictions on
generic declarations</em> of the current Fortran 2023 standard (see for
instance <a href="https://j3-fortran.org/doc/year/23/23-007r1.pdf">draft
23-007r1.pdf</a>, page 316)</p>
<blockquote>
<p>Two dummy arguments are distinguishable if</p>
<ul>
<li>one is a procedure and the other is a data object,</li>
<li>they are both data objects or known to be functions, and neither is
TKR compatible with the other, one has the ALLOCATABLE attribute and the
other has the POINTER attribute and not the INTENT (IN) attribute,
or</li>
<li>one is a function with nonzero rank and the other is not known to be
a function.</li>
</ul>
</blockquote>
<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></li>
</ol>
</section>
</body>
</html>
